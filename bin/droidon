#!/usr/bin/python3


import configparser
import shlex
import subprocess
import sys


class Manifest:

    def __init__(self, resources):
        self.resources = resources

    @classmethod
    def from_ini_file_path(cls, file_path):
        parser = configparser.ConfigParser()
        parser.read(file_path)
        resources = []
        for section_name in parser.sections():
            parts = shlex.split(section_name)
            if parts[0] == "package":
                resources.append(PackageResource(parts[1]))
            else:
                raise Exception()
        return cls(resources)


class PackageResource:

    def __init__(self, name):
        self.name = name

    def is_needed(self):
        all_data = subprocess.check_output(["adb", "shell", "pm", "list", "packages", "-f"])
        # Disabled packages:
        #all_data = subprocess.check_output(["adb", "shell", "pm", "list", "packages", "-f", "-d"])
        packages = set()
        for line in all_data.decode().splitlines():
            name = line.strip().rsplit("=", 1)[-1]
            packages.add(name)
        #print(packages)
        return self.name not in packages

    def apply(self):
        pass # FIXME


class Droidon:

    def main(self):
        manifest = Manifest.from_ini_file_path(sys.argv[1])
        for resource in manifest.resources:
            print("%s: %s" % (resource.name, resource.is_needed()))


if __name__ == '__main__':
    Droidon().main()
