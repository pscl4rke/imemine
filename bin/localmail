#!/usr/bin/python3
#======================================================================#
# LOCALMAIL EMAIL MANAGEMENT SHELL               (c) 2018 P. S. Clarke #
#======================================================================#


"""
Easiest way is to use this as the interpreter in the hashbang of
your config file:

    #!/path/to/localmail
    # vim:ft=dosini:

    [sync]
    offlineimaprc = /path/to/offlineimap_config_file

    [manage]
    muttrc = /path/to/mutt_config_file

    [search]
    muhome = /path/to/indexing/dir
    maildir = /path/to/email/folders
    ; NOTE: don't put results into base directory or it will get synced!
    linksdir = /path/to/results/folder
"""


import configparser
import subprocess
import sys

import readline
assert readline


class LocalMail:

    def __init__(self):
        self.config = configparser.ConfigParser()

    def main(self):
        config_path = sys.argv[1]
        self.config.read(config_path)
        self.keep_prompting()

    def keep_prompting(self):
        while True:
            print("1: sync")
            print("2: manage-ro")
            print("3: manage-rw")
            print("4: search")
            cmd = self.ask_for_command()
            if cmd == "1":
                self.handle_sync()
            elif cmd == "2":
                self.handle_manage_ro()
            elif cmd == "3":
                self.handle_manage_rw()
            elif cmd == "4":
                self.handle_search()
            elif cmd == "q":
                print("Exiting...")
                break
            else:
                print("Huh??")

    def ask_for_command(self):
        try:
            return input("#? ")
        except EOFError:
            return "q"
        except KeyboardInterrupt:
            return "q"

    def handle_sync(self):
        offlineimaprc = self.config['sync']['offlineimaprc']
        subprocess.call(["offlineimap", "-c", offlineimaprc])

    def handle_manage_ro(self):
        muttrc = self.config['manage']['muttrc']
        subprocess.call(["mutt", "-R", "-F", muttrc])

    def handle_manage_rw(self):
        muttrc = self.config['manage']['muttrc']
        subprocess.call(["mutt", "-F", muttrc])

    def handle_search(self):
        # Warning - what if this checks the index into version control!
        # Warning - what if this syncs the results onto the remote server!
        muhome = self.config['search']['muhome']
        maildir = self.config['search']['maildir']
        linksdir = self.config['search']['linksdir']
        subprocess.call(["mu", "index", "--muhome", muhome, "-m", maildir])
        query = input("Query: ")
        query_parts = query.split()
        #cmd = ["mu", "find", "--muhome", muhome, "-u"]
        #cmd.extend(query.split())
        #subprocess.call(cmd)
        cmd = ["mu", "find", "--muhome", muhome, "-u", "--format", "links", "--linksdir", linksdir]  #--clearlinks
        cmd.extend(query.split())
        subprocess.call(cmd)
        muttrc = self.config['manage']['muttrc']
        subprocess.call(["mutt", "-R", "-F", muttrc, "-f", linksdir])


if __name__ == '__main__':
    LocalMail().main()
