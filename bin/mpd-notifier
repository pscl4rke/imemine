#!/usr/bin/env python
#
#======================================================================#
# MPD-TO-LIBNOTIFY TOOL                          (c) 2012 P. S. Clarke #
#======================================================================#

# Find a way to run this in the background when you log in.
# For example, using $HOME/.config/autostart.
# You probably should use run-mpd-notifier to wrap this and
# automatically restart it when it (frequently) crashes.

# Dependencies:
#   -   MPD and `python-mpd` package or equivalent
#   -   libnotify and `python-notify` package or equivalent

# Bugs:
#   -   On launch, will always announce head of playlist even if
#       not playing.
#   -   Assumes MPD running on localhost

import mpd
import time
import pynotify
pynotify.init("mpdude")

def notify(identifier):
	n = pynotify.Notification(*identifier)
	n.show()

def cycle(client):
    last_identifier = (None, None)
    while True:
        time.sleep(2)
        song_data = client.currentsong()
        if 'title' in song_data and 'album' in song_data:
            identifier = (song_data['title'], song_data['album'])
        else:
            identifier = ("Not playing", "")
        if identifier != last_identifier:
            notify(identifier)
            last_identifier = identifier

def main():
    try:
        client = mpd.MPDClient()
        client.connect("localhost", 6600)
        cycle(client)
    except Exception, e:
        print "Crash occurred:"
        print "%s: %s" % (type(e).__name__, e)
        print "You should restart me now!"
        del client

if __name__ == '__main__':
    main()

