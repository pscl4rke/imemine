#!/usr/bin/python3


import os
import sys

import mutagen


# improve genre checking
# check title-case tracks
# check artist names first-last
# check id3v1 data matches id3v2 data
# check filename matches id3v2 data
# check album art of good quality
# check classical music for Composer etc
# perhaps check the year


def check(path_to_check):
    if os.path.isdir(path_to_check):
        yield from check_album_dir(path_to_check)
    if path_to_check.endswith(".mp3"):
        yield from check_mp3(path_to_check)


def check_album_dir(path_to_check):
    files = os.listdir(path_to_check)
    if "Folder.jpg" not in files:
        yield path_to_check, "Missing Folder.jpg"
    for filename in files:
        path = os.path.join(path_to_check, filename)
        if filename.endswith(".mp3"):
            yield from check_mp3(path)
        elif filename == "Folder.jpg":
            pass  # FIXME
        else:
            yield path, "Unexpected file"


def check_mp3(path_to_check):
    yield from check_from_wipe_mp3_junk_script(path_to_check)
    yield from check_track_numbering(path_to_check)
    yield from check_genre(path_to_check)


def check_from_wipe_mp3_junk_script(path_to_check):
    # See imemine/bin/wipe-mp3-junk for a script that cleans up the mp3
    # files but I keep forgetting exists.
    src = mutagen.File(path_to_check)
    for prefix in ["TXXX", "TSSE", "TENC", "TDEN", "TLEN", "TBPM", "TFLT", "TPOS",
                   "TMED", "TCOP", "TPUB", "APIC", "PRIV", "MCDI", "COMM", "TCMP"]:
        for key in src:
            if key.startswith(prefix):
                yield path_to_check, "Contains key %r saying %r" % (key, src[key])


def check_track_numbering(path_to_check):
    src = mutagen.File(path_to_check)
    if "TRCK" not in src:
        yield path_to_check, "Missing track number"
    else:
        if "/" not in src["TRCK"].text[0]:
            yield path_to_check, "Track number missing total number of tracks"


def check_genre(path_to_check):
    src = mutagen.File(path_to_check)
    if "TCON" not in src:
        yield path_to_check, "Missing genre"
        return
    genre = src["TCON"].text[0]
    if genre == "":
        yield path_to_check, "Blank genre"
    if ";" in genre:
        yield path_to_check, "Invalid multigenre"


def display(path, problem, dest):
    coloured = dest.isatty()
    parts = []
    if "/" in path:
        dir, base = path.rsplit("/", 1)
    else:
        dir, base = path, "n/a"  # FIXME
    if coloured:
        parts.append("\x1b[34;1m")
    parts.append("%s/" % dir)
    if coloured:
        parts.append("\x1b[0m")
        parts.append("\x1b[34m")
    parts.append("%s: " % base)
    if coloured:
        parts.append("\x1b[0m")
        parts.append("\x1b[31m")
    parts.append(problem[:200])
    if coloured:
        parts.append("\x1b[0m")
    parts.append("\n")
    dest.write("".join(parts))


def main():
    for path_to_check in sys.argv[1:]:
        for path, problem in check(path_to_check):
            display(path, problem, sys.stdout)


if __name__ == '__main__':
    main()
