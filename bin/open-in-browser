#!/usr/bin/env bash
#======================================================================#
# WEB-BROWSING LAUNCH WRAPPER               (c) 2012-2020 P. S. Clarke #
#======================================================================#

# maybe /usr/bin, /maybe /snap/bin, maybe somewhere else...
chromium="$(which chromium-browser || which chromium)"

if [[ -e /usr/bin/firefox ]]
then
    browser="firefox"
else
    browser="chrome"
fi
mode="temp"

while [[ ! -z "$1" ]]; do
case "$1" in
    -b)
        shift
        browser="$1" ; shift
        ;;
    -p)
        mode="profile" ; shift
        profile="$1" ; shift
        ;;
    *)
        break
        ;;
esac
done

case "$1" in
    PRIMARY)
        url="$(xclip -o -selection primary)"
        ;;
    CLIPBOARD)
        url="$(xclip -o -selection clipboard)"
        ;;
    PROMPT)
        url="$(zenity --entry --text="URL" --title="URL")"
        [ -z "$url" ] && exit 1
        ;;
    *)
        url="$1"
        ;;
esac

urlclean="$(dirname "$0")/urlclean"
url="$(urlclean "$url")"
#zenity --info --text "$url"

case "$browser-$mode" in
    chrome-temp)
        # --temp-profile must be first if it is to be obeyed:
        $chromium --temp-profile --no-first-run \
            --no-default-browser-check "$url" 2>&1 >/dev/null
        ;;
    chrome-profile)
        $chromium --user-data-dir="$HOME/.config/chromium-$profile" \
            --no-default-browser-check --new-window "$url" 2>&1 >/dev/null
        ;;
    firefox-temp)
        profilepath="$(mktemp --directory /tmp/firefox.$$.XXXXXXX)"
        [ -e ~/.firefox.base.tar ] && (
            cd "$profilepath"
            tar xf ~/.firefox.base.tar)
        firefox -no-remote -profile "$profilepath" "$url" 2>&1 >/dev/null
        rm -r "$profilepath"
        ;;
    firefoxreader-temp)
        profilepath="$(mktemp --directory /tmp/firefox.$$.XXXXXXX)"
        [ -e ~/.firefox.base.tar ] && (
            cd "$profilepath"
            tar xf ~/.firefox.base.tar)
        firefox -no-remote -profile "$profilepath" "about:reader?url=$url" 2>&1 >/dev/null
        rm -r "$profilepath"
        ;;
    firefox-profile)
        profilepath="$HOME/.config/firefox-$profile"
        mkdir "$profilepath"
        firefox -no-remote -profile "$profilepath" "$url" 2>&1 >/dev/null
        ;;
    qutebrowser-temp)
        profilepath="$(mktemp --directory /tmp/qutebrowser.$$.XXXXXXX)"
        $HOME/.virtualenvs/qutebrowser/bin/qutebrowser \
            --basedir "$profilepath" "$url" 2>&1 >/dev/null
        rm -r "$profilepath"
        ;;
    *)
        echo "Unknown: $browser-$mode"
        zenity --error --title "$0" --text "Unknown: $browser-$mode"
        ;;
esac

