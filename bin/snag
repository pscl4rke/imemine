#!/usr/bin/python
#======================================================================#
# REMOTE FILE SNAGGER                            (c) 2017 P. S. Clarke #
#======================================================================#


import shlex
import subprocess
import sys


class DummySource:

    def set_up(self):
        pass

    def tear_down(self):
        pass

    def pull(self, destination, shell_cmd):
        raise NotImplementedError("Unconfigured 'using' source")


class GenericSource:

    def __init__(self, prefix_args):
        self.prefix_args = prefix_args

    def set_up(self):
        pass

    def tear_down(self):
        pass

    def pull(self, destination, shell_cmd):
        args = list(self.prefix_args)
        args.append(shell_cmd)
        output = subprocess.check_output(args)
        # Note that we only overwrite the file if the cmd worked
        with open(destination, "w") as destfile:
            destfile.write(output)


class Snagger:

    def main(self, arguments):
        if len(arguments) != 2:
            print "Usage error"
            sys.exit(1)
        filename = arguments[1]
        self.current_source = DummySource()
        self.current_source.set_up()
        try:
            self.pull_according_to(filename)
        finally:
            self.current_source.tear_down()

    def pull_according_to(self, filename):
        for line in open(filename):
            self.handle_line(line.strip())

    def handle_line(self, line):
        if line == "":
            return
        if line.startswith("#"):
            return
        if line.startswith("!using "):
            self.current_source.tear_down()
            self.current_source = GenericSource(shlex.split(line[7:]))
            self.current_source.set_up()
            return
        if line.startswith("!run "):
            self.run(line[5:])
            return
        if "\t" in line:
            destination, _tab, shell_cmd = line.strip().partition("\t")
            self.pull(destination, shell_cmd)
            return
        print "Unknown line: %r" % line

    def run(self, shell_cmd):
        print "Running %r..." % shell_cmd
        subprocess.check_call(shell_cmd, shell=True)

    def pull(self, destination, shell_cmd):
        try:
            print "Snagging %s..." % destination
            self.current_source.pull(destination, shell_cmd)
        except subprocess.CalledProcessError:
            print "ERROR"


if __name__ == '__main__':
    Snagger().main(sys.argv)
