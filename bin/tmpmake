#!/bin/bash

# Running without arguments will give an interactive shell.  If arguments are
# given then make will be run as a batch job with those arguments.
#
# FIXME - probably should use a matching exit code during batch mode

makefile=$(realpath "$1")

function setUp {
    tmpdir=$(mktemp -d -t tmpmake."$(basename "$makefile")".XXXXXXX)
    echo "From $makefile" 1>&2
    ln -s "$makefile" "$tmpdir/Makefile"
    echo "Using $tmpdir" 1>&2
    cd "$tmpdir"
}

function tearDown {
    echo "Tearing down $tmpdir" 1>&2
    cd /
    rm -r "$tmpdir"
}

setUp
trap tearDown EXIT

shift
if [[ $# -gt 0 ]]; then
    make "$@"
else
    ${SHELL-/bin/bash}
fi
