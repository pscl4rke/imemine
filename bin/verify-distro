#!/usr/bin/python3


import getpass
import glob
import grp
import os
from os.path import expanduser
import subprocess
import unittest


def shell(cmdline: str) -> str:
    proc = subprocess.run(["bash", "-c", cmdline], check=True, capture_output=True)
    return proc.stdout.decode()


class TestUtils(unittest.TestCase):

    def test_cal_makes_wednesday_the_hump_day(self):
        output = shell("cal")
        self.assertIn("Su Mo Tu We Th Fr Sa", output)

    def test_bash_completion_is_installed(self):
        path = "/usr/share/bash-completion/bash_completion"
        self.assertTrue(os.path.exists(path))

    def test_there_isnt_an_outofdate_downloader(self):
        path = "/usr/bin/yt-dlp"
        self.assertFalse(os.path.exists(path))


class TestSession(unittest.TestCase):

    def test_lxsession_isnt_creating_big_logfiles(self):
        paths = glob.glob(expanduser("~/.config/**/debug.log"))
        self.assertEqual(paths, [])  # was ~/.config/lxqt/debug.log


class TestSkeletonFiles(unittest.TestCase):

    def test_xdg_files_on_the_desktop(self):
        # Note that if you try to delete these pcmanfm will "helpfully"
        # add them back next time you log in.  So instead run
        # "pcmanfm-qt --desktop-pref advanced" or fiddle the config file.
        paths = glob.glob(expanduser("~/Desktop/*.desktop"))
        self.assertEqual(paths, [])


class TestUser(unittest.TestCase):

    def test_i_have_sudo_privileges(self):
        sudo = grp.getgrnam("sudo").gr_mem
        self.assertIn(getpass.getuser(), sudo)

    def test_i_have_logfile_privileges(self):
        adm = grp.getgrnam("adm").gr_mem
        self.assertIn(getpass.getuser(), adm)


if __name__ == "__main__":
    unittest.main()
