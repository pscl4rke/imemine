#!/usr/bin/python3
#======================================================================#
# REFLOW PARAGRAPHS FOR WORDPRESS           (c) 2015,2019 P. S. Clarke #
#======================================================================#


import sys
import unittest


def reflow(paragraph):
    preformatted = paragraph[0][0] in " \t"
    blockquote = paragraph[0][0] in ">"
    chunks = []
    if blockquote:
        chunks.append(">")
    for line in paragraph:
        if line.strip().startswith("%"): # comment
            return ""
        if blockquote:
            chunks.append(line.lstrip("> \t"))
        else:
            chunks.append(line)
    joiner = "\n" if preformatted else " "
    return joiner.join(chunks) + "\n"


def split_into_paragraphs(lines):
    paragraphs = []
    current_paragraph = []
    currently_whitespace = True
    for line in lines:
        if line.strip() == "":
            if not currently_whitespace:
                paragraphs.append(current_paragraph)
                current_paragraph = []
            currently_whitespace = True
        else:
            current_paragraph.append(line)
            currently_whitespace = False
    if len(current_paragraph) > 0:
        paragraphs.append(current_paragraph)
    return paragraphs


def wpflow(src):
    pars = []
    for paragraph in split_into_paragraphs(src.splitlines()):
        pars.append(reflow(paragraph))
    return "\n".join(pars)


class TestWpflow(unittest.TestCase):

    def test_paragraphs(self):
        text_in = "foo\nbar\n\nbaz\nquux\n"
        text_out = "foo bar\n\nbaz quux\n"
        self.assertEqual(text_out, wpflow(text_in))

    def test_code(self):
        text_in = "    foo\n    bar\n"
        text_out = "    foo\n    bar\n"
        self.assertEqual(text_out, wpflow(text_in))

    def test_blockquotes(self):
        text_in = "> foo\n> bar\n"
        text_out = "> foo bar\n"
        self.assertEqual(text_out, wpflow(text_in))

    def test_bullets(self):
        text_in = "* foo\nbar\n"
        #text_out = "* foo bar"
        text_out = "* foo bar\n"
        self.assertEqual(text_out, wpflow(text_in))


if __name__ == '__main__':
    if "--test" in sys.argv:
        sys.argv = [sys.argv[0]]
        unittest.main()
    else:
        sys.stdout.write(wpflow(sys.stdin.read()))
