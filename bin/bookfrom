#!/usr/bin/env tmpmake
# vim:ft=make:

sources := $(wildcard *.url)
bodies := $(subst url,body,$(sources))
title := $(shell cat meta.title)
author := $(shell cat meta.author)

book.epub: $(bodies)
	@echo "CHECKING METADATA..."
	test "$(title)"
	test "$(author)"
	@echo "BUILDING $@..."
	pandoc -f html -t epub3 -o $@ \
		--number-sections \
		--metadata=title:"$(title)" \
		--metadata=author:"$(author)" \
		$^

%.body: %.url
	@echo "FETCHING $@..."
	readable "$$(cat $^)" > $@.tmp
	mv $@.tmp $@


# --epub-title-page=false
# --epub-cover-image=FILE
# --toc     <-- pointless because pandoc will only detect <h1> when
#               directly inside <body> tag, not in a <div>


urls: sources
	cat $^ | nl -n rz -w 2 | while read number url; do \
		echo "$$url" > "$$number.url" ;\
	done
